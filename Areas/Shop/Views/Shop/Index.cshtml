@model avatCo.Models.ViewModel.ShopViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Add CSS reference correctly -->
<link rel="stylesheet" href="~/css/shopHead.css" />

<!-- Search Section -->
<section class="search-section">
    <div class="container">
        <div class="search-container text-center">
            <!-- Make search form work with your backend -->
            <form id="searchForm" method="get" action="@Url.Action("Index", "Shop")">
                <div class="search-box">
                    <input type="text" 
                           class="search-input" 
                           name="q"
                           @* value="@Model.Query" *@
                           placeholder="نام محصول، دسته بندی یا برند مورد نظر را جستجو کنید...">
                    <button type="submit" class="search-button">جستجو</button>
                </div>
            </form>
            
            <div class="category-filters">
                <!-- Make category filters work with your backend -->
                <button type="button" class="category-btn" data-category="شیشه آلات">شیشه آلات</button>
                <button type="button" class="category-btn" data-category="مواد شیمیایی">مواد شیمیایی</button>
                <button type="button" class="category-btn" data-category="تجهیزات پزشکی">تجهیزات پزشکی</button>
                <button type="button" class="category-btn" data-category="لوازم مصرفی">لوازم مصرفی</button>
                <button type="button" class="category-btn" data-category="دستگاه‌های آزمایشگاهی">دستگاه‌های آزمایشگاهی</button>
            </div>
        </div>
    </div>
</section>

<!-- Categories Section -->
<section class="container my-5"> 
    <div class="d-flex justify-content-between align-items-center mb-3"> 
        <h4 class="fw-bold">دسته‌بندی‌ها</h4>
        <a href="/Shop" class="btn btn-outline-dark">مشاهده همه</a> 
    </div> 
    <div class="d-flex flex-wrap gap-2">
        @foreach (var c in Model.Categories)
        {
            <a href="@Url.Action("Index", "Shop", new { category = c.Name })" 
               class="btn btn-outline-secondary @(Model.CategoryName == c.Name ? "active" : "")">
                @c.Name 
            </a>
        } 
    </div> 
</section>

<!-- Products Section -->
<section class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold">محصولات</h4>
        <a href="/Shop" class="btn btn-outline-dark">مشاهده همه</a>
    </div>

    <!-- Search Results Info -->
    @* @if (!string.IsNullOrEmpty(Model.Query))
    {
        <div class="alert alert-info">
            <strong>نتایج جستجو برای:</strong> "@Model.Query"
            @if (!string.IsNullOrEmpty(Model.Category))
            {
                <span> در دسته <strong>@Model.Category</strong></span>
            }
            <span> - @Model.TotalCount محصول یافت شد</span>
            <a href="@Url.Action("Index", "Shop")" class="btn btn-sm btn-outline-danger me-2">حذف فیلترها</a>
        </div>
    } *@

    <div class="row g-4" id="productsGrid">
        @if (!Model.Products.Any())
        {
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="bi bi-search display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">محصولی یافت نشد</h4>
                    <p class="text-muted">لطفاً عبارت جستجو یا فیلترها را تغییر دهید</p>
                    <a href="@Url.Action("Index", "Shop")" class="btn btn-primary">مشاهده همه محصولات</a>
                </div>
            </div>
        }
        @foreach (var p in Model.Products)
        {
            <div class="col-6 col-md-3">
                <div class="card h-100 product-card shadow-sm border-0">
                    <img src="@p.ImageUrl" class="card-img-top" alt="@p.Title"
                         style="height:220px; object-fit:cover; border-top-left-radius:1rem; border-top-right-radius:1rem;" />
                    <div class="card-body text-center d-flex flex-column">
                        <h6 class="fw-semibold">@p.Title</h6>
                        <p class="small text-muted mb-1">@p.Brand</p>
                        <p class="text-success fw-bold mb-2">@p.Price.ToString("N0") تومان</p>
                        <div class="mt-auto">
                            <button class="btn btn-sm btn-dark rounded-pill w-100"
                                    type="button"
                                    onclick="openDetailProductModal(@p.Id)">
                                مشاهده جزئیات
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    @* <!-- Pagination -->
    @if (Model.TotalPages > 1)
    {
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                        <a class="page-link" 
                           href="@Url.Action("Index", "Shop", new { q = Model.Query, category = Model.Category, page = i })">
                            @i
                        </a>
                    </li>
                }
            </ul>
        </nav>
    }
</section> *@

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pd-modal-title">...</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body p-3">
                <div class="row">
                    <div class="col-md-6 text-center">
                        <img id="pd-modal-image" src="" alt="" class="img-fluid border rounded" style="max-height:360px; object-fit:cover;" />
                    </div>

                    <div class="col-md-6">
                        <h4 class="text-danger" id="pd-modal-price">...</h4>
                        <p class="text-muted" id="pd-modal-category">...</p>
                        <button class="btn btn-danger mt-2" id="pd-add-to-cart">🛒 افزودن به سبد</button>

                        <hr />
                        <h5>مشخصات</h5>
                        <ul class="list-unstyled small">
                            <li><b>برند:</b> <span id="pd-modal-brand">-</span></li>
                            <li><b>جنس:</b> <span id="pd-modal-material">-</span></li>
                            <li><b>موجودی:</b> <span id="pd-modal-stock">-</span></li>
                        </ul>
                    </div>
                </div>

                <hr />

                <ul class="nav nav-tabs mt-2" id="productTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="tab-desc" data-bs-toggle="tab" href="#tab-content-desc" role="tab">توضیحات</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="tab-opinions" data-bs-toggle="tab" href="#tab-content-opinions" role="tab">نظرات</a>
                    </li>
                </ul>

                <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="tab-content-desc" role="tabpanel">
                        <div id="pd-modal-description"></div>
                    </div>

                    <div class="tab-pane fade" id="tab-content-opinions" role="tabpanel">
                        <div id="pd-opinions-list" class="mb-3"></div>
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addOpinionModal">افزودن نظر</button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <small class="text-muted me-auto">مشاهده جزئیات محصول</small>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Opinion Modal -->
<div class="modal fade" id="addOpinionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addOpinionForm" method="post" action="@Url.Action("AddOpinion", "Shop")">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">افزودن نظر</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="ProductId" id="op-product-id" value="" />
                    <div class="mb-3">
                        <label class="form-label">امتیاز</label>
                        <select name="Rating" class="form-select" required>
                            <option value="">انتخاب امتیاز</option>
                            <option value="5">عالی (5 ستاره)</option>
                            <option value="4">خوب (4 ستاره)</option>
                            <option value="3">متوسط (3 ستاره)</option>
                            <option value="2">ضعیف (2 ستاره)</option>
                            <option value="1">خیلی ضعیف (1 ستاره)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">نظر شما</label>
                        <textarea name="Comment" class="form-control" rows="4" required placeholder="نظر خود را در مورد این محصول بنویسید..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                    <button type="submit" class="btn btn-primary">ثبت نظر</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Fixed script tag -->
    <script src="~/js/search.js"></script>

    <script>
        // Ensure jQuery is loaded before this
        $(document).ready(function() {
            
            // Make category filter buttons work
            $('.category-filters .category-btn').on('click', function() {
                const category = $(this).data('category');
                $('#searchForm').append('<input type="hidden" name="category" value="' + category + '">');
                $('#searchForm').submit();
            });

            // Auto-search when typing (optional)
            $('.search-input').on('input', debounce(function() {
                const query = $(this).val();
                if (query.length > 2 || query.length === 0) {
                    // You can implement AJAX search here if needed
                    console.log('Search query:', query);
                }
            }, 500));

            // Initialize tooltips if any
            $('[data-bs-toggle="tooltip"]').tooltip();
        });

        // Global function used by your "مشاهده جزئیات" buttons
        window.openDetailProductModal = function (id) {
            if (!id) return alert("Invalid id");

            $.getJSON("/Shop/GetProduct/" + id)
              .done(function (data) {
                // Fill modal fields
                $("#pd-modal-title").text(data.title || "-");
                $("#pd-modal-image").attr("src", data.imageUrl || "/images/placeholder.png");
                $("#pd-modal-image").attr("alt", data.title || "");
                $("#pd-modal-price").text(data.price ? (Number(data.price).toLocaleString() + " تومان") : "-");
                $("#pd-modal-category").text(data.categoryName || "-");
                $("#pd-modal-brand").text(data.brand || "-");
                $("#pd-modal-material").text(data.material || "-");
                $("#pd-modal-stock").text(data.isActive ? "بله" : "خیر");
                $("#pd-modal-description").html(data.description ? data.description.replace(/\n/g, '<br>') : "بدون توضیح");

                // Set productId for add-opinion form
                $("#op-product-id").val(data.id);

                // Render opinions
                function renderOpinions(list) {
                  var $out = $("#pd-opinions-list").empty();
                  if (!list || list.length === 0) {
                    $out.append('<p class="text-muted">هنوز نظری ثبت نشده است.</p>');
                    return;
                  }
                  list.forEach(function (op) {
                    var stars = '★'.repeat(op.rating) + '☆'.repeat(5 - op.rating);
                    var tpl = `<div class="border p-2 mb-2 rounded">
                                 <div class="d-flex justify-content-between">
                                   <strong>${escapeHtml(op.userName || "کاربر")}</strong>
                                   <span class="text-warning">${stars}</span>
                                 </div>
                                 <div class="small text-muted">${op.createdAt ? new Date(op.createdAt).toLocaleDateString('fa-IR') : ""}</div>
                                 <p class="mt-1 mb-0">${escapeHtml(op.comment || "")}</p>
                               </div>`;
                    $out.append(tpl);
                  });
                }

                renderOpinions(data.opinions || []);

                // Show modal
                var modalEl = document.getElementById('productDetailsModal');
                var bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
                bsModal.show();
              })
              .fail(function (xhr) {
                var msg = "خطا در بارگذاری جزئیات محصول";
                if (xhr && xhr.status === 404) msg = "محصولی یافت نشد";
                alert(msg);
              });
        };

        // Helper to avoid XSS when injecting simple text
        function escapeHtml(s) {
            if (!s) return "";
            return String(s)
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
        }

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Submit opinion via AJAX and refresh modal opinions on success
        $(document).on("submit", "#addOpinionForm", function (e) {
            e.preventDefault();
            var $form = $(this);
            var formData = $form.serialize();

            // Get antiforgery token and include in header
            var token = $form.find("input[name='__RequestVerificationToken']").val();

            $.ajax({
              url: $form.attr("action"),
              method: "POST",
              data: formData,
              headers: {
                "RequestVerificationToken": token
              }
            }).done(function (res) {
              if (res && res.success) {
                // Close addOpinionModal
                var addModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addOpinionModal'));
                addModal.hide();

                // Reset form
                $form[0].reset();

                // Refresh product detail modal (reload data)
                var productId = $("#op-product-id").val();
                if (productId) openDetailProductModal(parseInt(productId));
                
                alert("نظر شما با موفقیت ثبت شد");
              } else {
                alert(res && res.message ? res.message : "خطا در ثبت نظر");
              }
            }).fail(function (xhr) {
              alert("خطای سرور هنگام ثبت نظر: " + (xhr.responseJSON?.message || ""));
            });
        });

        // Add to cart functionality
        $("#pd-add-to-cart").on("click", function() {
            const productId = $("#op-product-id").val();
            if (!productId) {
                alert("خطا در شناسایی محصول");
                return;
            }
            
            // Implement your add to cart logic here
            console.log("Add to cart:", productId);
            alert("محصول به سبد خرید اضافه شد");
        });
    </script>
}