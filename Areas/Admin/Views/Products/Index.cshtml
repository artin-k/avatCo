@model List<avatCo.Models.Product>
@{
    ViewData["Title"] = "product";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var categories = ViewBag.Categories as List<avatCo.Models.Category>;
}

<h4>Products</h4>
<button class="btn btn-primary" id="goToCategory">View Categories</button>

<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createProductModal">Add Product</button>

<table class="table mt-3">
    <thead>
        <tr>
            <th>Product Image</th>
            <th>Title</th>
            <th>Is Active</th>
            <th>Is Special Offer</th>
            <th>Price</th>
            <th>description</th>
            <th>Categories</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var p in Model)
        {
            <tr>
                <td>
                    @if (!string.IsNullOrEmpty(p.ImageUrl))
                    {
                        <img src="@p.ImageUrl" alt="@p.Title" width="60" height="60" style="object-fit:cover;" />
                    }
                </td>
                <td>@p.Title</td>
                <td>
                    @if (p.IsActive)
                    {
                        <span class="badge bg-success">Active</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">Inactive</span>
                    }
                </td>
                <td>
                    @if (p.IsSpecialOffer)
                    {
                        <span class="badge bg-warning text-dark">Special Offer</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">Not Special Offer</span>
                    }
                </td>
                <td>@p.Price.ToString("0.##")</td>
                <td>@p.Description</td>
                <td>@(p.Category != null ? p.Category.Name : "No Category")</td>
                <td>
                    <button class="btn btn-success" onclick="openEditProductModal(@p.Id)">Edit</button>
                    <button class="btn btn-danger" onclick="deleteProduct(@p.Id)">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Create Product Modal -->
<div class="modal fade" id="createProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createProductForm" method="post" enctype="multipart/form-data" action="@Url.Action("Create", "Products", new { area = "Admin" })">
                    @Html.AntiForgeryToken()

                    <div class="mb-3">
                        <label for="CategoryId" class="form-label">Category</label>
                        <select id="CategoryId" name="CategoryId" class="form-control" required>
                            <option value="">Select a Category</option>
                            @foreach (var cat in categories)
                            {
                                <option value="@cat.Id">@cat.Name</option>
                            }
                        </select>
                    </div>

                    <!-- IsActive -->
                    <input type="hidden" name="IsActive" value="false" />
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="IsActive" id="IsActive" value="true" />
                        <label class="form-check-label" for="IsActive">Is Active</label>
                    </div>

                    <!-- IsSpecialOffer -->
                    <input type="hidden" name="IsSpecialOffer" value="false" />
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="IsSpecialOffer" id="IsSpecialOffer" value="true" />
                        <label class="form-check-label" for="IsSpecialOffer">Special Offer</label>
                    </div>

                    <div class="mb-3">
                        <label for="ImageFile_Create" class="form-label">Product Image</label>
                        <input type="file" id="ImageFile_Create" name="ImageFile" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="Title" class="form-label">Title</label>
                        <input id="Title" name="Title" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="Price" class="form-label">Price</label>
                        <input type="number" id="Price" name="Price" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="Description" class="form-label">Description</label>
                        <textarea id="Description" name="Description" class="form-control"></textarea>
                    </div>

                    <button type="submit" class="btn btn-success">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm" method="post" enctype="multipart/form-data" action="@Url.Action("Edit", "Products", new { area = "Admin" })">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="Id" />

                    <input type="hidden" name="IsActive" value="false" />
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="IsActive" id="editIsActive" value="true" />
                        <label class="form-check-label" for="editIsActive">Is Active</label>
                    </div>

                    <input type="hidden" name="IsSpecialOffer" value="false" />
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="IsSpecialOffer" id="editIsSpecialOffer" value="true" />
                        <label class="form-check-label" for="editIsSpecialOffer">Special Offer</label>
                    </div>

                    <div class="mb-3">
                        <label for="ImageFile" class="form-label">Product Image</label>
                        <input type="file" id="ImageFile" name="ImageFile" class="form-control" />
                        <div id="currentImagePreview" class="mt-2"></div>
                    </div>

                    <div class="mb-3">
                        <label for="Title" class="form-label">Title</label>
                        <input type="text" name="Title" id="editTitle" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="Price" class="form-label">Price</label>
                        <input type="number" name="Price" id="editPrice" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="Description" class="form-label">Description</label>
                        <textarea name="Description" id="editDescription" class="form-control"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="CategoryId" class="form-label">Category</label>
                        <select name="CategoryId" id="editCategoryId" class="form-control" required>
                            <option value="">Select a Category</option>
                            @foreach (var cat in categories)
                            {
                                <option value="@cat.Id">@cat.Name</option>
                            }
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // go to categories
        document.getElementById("goToCategory").addEventListener("click", function () {
            window.location.href = "/Admin/Categories";
        });

        // make openEditProductModal globally available (onclick uses it)
        window.openEditProductModal = function (id) {
            $.getJSON("/Admin/Products/GetProduct/" + id)
                .done(function (data) {
                    $("#editProductForm input[name='Id']").val(data.id);

                    $("#editTitle").val(data.title);
                    $("#editPrice").val(data.price);
                    $("#editDescription").val(data.description);
                    $("#editCategoryId").val(data.categoryId);

                    $("#editIsActive").prop("checked", data.isActive === true);
                    $("#editIsSpecialOffer").prop("checked", data.isSpecialOffer === true);


                    if (data.imageUrl) {
                        $("#currentImagePreview").html('<img src="' + data.imageUrl + '" alt="Current Image" width="100" style="object-fit:cover;" />');
                    } else {
                        $("#currentImagePreview").html('');
                    }

                    $("#editProductModal").modal("show");
                })
                .fail(function (xhr) {
                    alert("Error loading product data: " + xhr.statusText);
                });
        };

        // submit create via AJAX
        $(document).on("submit", "#createProductForm", function (e) {
            e.preventDefault();
            var form = this;
            var fd = new FormData(form);

            // ensure checkbox values are sent
            fd.set("IsActive", $("#IsActive").is(":checked"));
            fd.set("IsSpecialOffer", $("#IsSpecialOffer").is(":checked"));

            var token = $(form).find("input[name='__RequestVerificationToken']").val();
            if (token) fd.append("__RequestVerificationToken", token);

            $.ajax({
                url: $(form).attr("action"),
                type: "POST",
                data: fd,
                contentType: false,
                processData: false
            }).done(function (res) {
                if (res && res.success) {
                    $("#createProductModal").modal("hide");
                    location.reload();
                } else {
                    alert(res?.message || "Create failed");
                }
            }).fail(function (xhr) {
                alert("Error creating product: " + xhr.status + " - " + xhr.responseText);
            });
        });

        $(document).on("submit", "#editProductForm", function (e) {
            e.preventDefault();
            var form = this;
            var fd = new FormData(form);

            // ensure checkbox values are sent
            fd.set("IsActive", $("#editIsActive").is(":checked"));
            fd.set("IsSpecialOffer", $("#editIsSpecialOffer").is(":checked"));

            var token = $(form).find("input[name='__RequestVerificationToken']").val();
            if (token) fd.append("__RequestVerificationToken", token);

            $.ajax({
                url: $(form).attr("action"),
                type: "POST",
                data: fd,
                contentType: false,
                processData: false
            }).done(function (res) {
                if (res && res.success) {
                    $("#editProductModal").modal("hide");
                    location.reload();
                } else {
                    alert(res?.message || "Update failed");
                }
            }).fail(function (xhr) {
                alert("Error updating product: " + xhr.status + " - " + xhr.responseText);
            });
        });


        // delete function exposed globally
        window.deleteProduct = function (id) {
            if (!confirm("Are you sure you want to delete this product?")) return;
            var token = $("input[name='__RequestVerificationToken']").first().val();
            $.post("/Admin/Products/Delete/" + id, { __RequestVerificationToken: token })
                .done(function (res) {
                    if (res && res.success) location.reload();
                    else alert(res?.message || "Delete failed");
                })
                .fail(function (xhr) {
                    alert("Error deleting product: " + xhr.status + " - " + xhr.responseText);
                });
        };
    </script>
}
